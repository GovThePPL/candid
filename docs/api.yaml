openapi: 3.0.3
info:
  title: Candid API
  description: API for Candid, a chat application for political discussion
  version: 0.1.0

servers:
  - url: http://127.0.0.1:8080/api/v1/
    description: Local API Server
  - url: wss://staging-ws.govtheppl.us/candid/v1
    description: Staging WebSocket server

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    CurrentUser:
      type: object
      required:
        - id
        - username
        - displayName
        - userType
        - status
      properties:
        id:
          type: string
          format: uuid
        username:
          type: string
        displayName:
          type: string
        email:
          type: string
          format: email
        avatarUrl:
          type: string
          description: Full size avatar (256x256) as base64 data URI
          nullable: true
        avatarIconUrl:
          type: string
          description: Icon size avatar (64x64) as base64 data URI
          nullable: true
        userType:
          type: string
          enum: [normal, moderator, admin, guest]
        status:
          type: string
          enum: [active, inactive, deleted, banned]
        joinTime:
          type: string
          format: date-time
        trustScore:
          type: number
          format: decimal
        kudosCount:
          type: integer
          description: Number of kudos received by the user
    User:
      type: object
      required:
        - id
        - username
        - displayName
        - status
      properties:
        id:
          type: string
          format: uuid
        username:
          type: string
        displayName:
          type: string
        avatarUrl:
          type: string
          description: Full size avatar (256x256) as base64 data URI
          nullable: true
        avatarIconUrl:
          type: string
          description: Icon size avatar (64x64) as base64 data URI
          nullable: true
        status:
          type: string
          enum: [active, inactive, deleted, banned]
        trustScore:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Trust score of the user, between 0 and 1
        kudosCount:
          type: integer
          description: Number of kudos received by the user

    Location:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          description: Display name of the location
        code:
          type: string
          nullable: true
          description: Short code for the location (e.g., "US", "OR")
        parentLocationId:
          type: string
          format: uuid
          nullable: true
          description: ID of the parent location (null for top-level)
        level:
          type: integer
          description: Hierarchy level (0 = top-level, higher = more specific)

    UserSettings:
      type: object
      properties:
        categoryWeights:
          type: array
          items:
            type: object
            required:
              - categoryId
              - weight
            properties:
              categoryId:
                type: string
                format: uuid
              weight:
                type: string
                enum: [most, more, default, less, least, none]
        chatRequestLikelihood:
          type: string
          enum: ["off", "rarely", "less", "normal", "more", "often"]
          description: How likely user is to receive chat requests (0=off, 1=rarely to 5=often)
        chattingListLikelihood:
          type: string
          enum: ["off", "rarely", "less", "normal", "more", "often"]
          description: How frequently items appear in user's chatting list (0=off, 1=rarely to 5=often)
        notificationsEnabled:
          type: boolean
          description: Whether push notifications are enabled
        notificationFrequency:
          type: string
          enum: ["off", "rarely", "less", "normal", "more", "often"]
          description: How many chat request notifications per day
        quietHoursStart:
          type: integer
          minimum: 0
          maximum: 23
          description: Hour to start quiet period (no notifications)
        quietHoursEnd:
          type: integer
          minimum: 0
          maximum: 23
          description: Hour to end quiet period
        timezone:
          type: string
          description: User timezone (e.g. America/New_York)

    UserDemographics:
      type: object
      properties:
        locationId:
          type: string
          format: uuid
        lean:
          type: string
          nullable: true
          enum: [very_liberal, liberal, moderate, conservative, very_conservative]
        affiliation:
          type: string
          format: uuid
          description: Reference to an affiliation entity
        education:
          type: string
          nullable: true
          enum: [less_than_high_school, high_school, some_college, associates, bachelors, masters, doctorate, professional]
        geoLocale:
          type: string
          nullable: true
          enum: [urban, suburban, rural]
        race:
          type: string
        sex:
          type: string
          nullable: true
          enum: [male, female, other]
        ageRange:
          type: string
          nullable: true
          enum: ['18-24', '25-34', '35-44', '45-54', '55-64', '65+']
        incomeRange:
          type: string
          nullable: true
          enum: [under_25k, 25k-50k, 50k-75k, 75k-100k, 100k-150k, 150k-200k, over_200k]
        createdTime:
          type: string
          format: date-time


    Position:
      type: object
      required:
        - id
        - creator
        - statement
        - categoryId
        - status
      properties:
        id:
          type: string
          format: uuid
        creator:
          $ref: '#/components/schemas/User'
        statement:
          type: string
        categoryId:
          type: string
          format: uuid
        category:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
            label:
              type: string
        location:
          type: object
          nullable: true
          properties:
            code:
              type: string
            name:
              type: string
        createdTime:
          type: string
          format: date-time
        agreeCount:
          type: integer
        disagreeCount:
          type: integer
        passCount:
          type: integer
        chatCount:
          type: integer
        status:
          type: string
          enum: [active, inactive, removed]
        source:
          type: string
          enum: [default, chatting_list]
          description: Where this position came from in the card queue
        hasPendingRequests:
          type: boolean
          description: Whether user has pending chat requests on this position (only for chatting_list source)
        chattingListId:
          type: string
          format: uuid
          description: ID of the chatting list item (only for chatting_list source)
        availability:
          type: string
          enum: [online, notifiable, none]
          description: Whether users are available to chat about this position

    UserPosition:
      type: object
      required:
        - id
        - userId
        - positionId
        - status
        - categoryId
        - locationId
        - statement
      properties:
        id:
          type: string
          format: uuid
        statement:
          type: string
        userId:
          type: string
          format: uuid
        positionId:
          type: string
          format: uuid
        locationId:
          type: string
          format: uuid
        categoryId:
          type: string
          format: uuid
        categoryName:
          type: string
          description: Name of the position category
        locationName:
          type: string
          description: Name of the position location
        status:
          type: string
          enum: [active, inactive, deleted, removed]
        agreeCount:
          type: integer
        disagreeCount:
          type: integer
        passCount:
          type: integer
        chatCount:
          type: integer

    PositionCategory:
      type: object
      required:
        - id
        - label
      properties:
        id:
          type: string
          format: uuid
        parentId:
          type: string
          format: uuid
          description: ID of the parent category (null for top-level categories)
        label:
          type: string
#        subcategories:
#          type: array
#          items:
#            $ref: '#/components/schemas/PositionCategory'

    Response:
      type: object
      required:
        - id
        - positionId
        - userId
        - response
      properties:
        id:
          type: string
          format: uuid
        positionId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        response:
          type: string
          enum: [agree, disagree, pass, chat]

    ChatRequest:
      type: object
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
        initiator:
          $ref: '#/components/schemas/User'
          readOnly: true
        initiatorUserId:
          type: string
          format: uuid
          readOnly: true
          description: ID of the user who initiated the chat request
        userPositionId:
          type: string
          format: uuid
          description: Required when creating a chat request
        response:
          type: string
          enum: [pending, accepted, dismissed, timeout]
          description: Required when responding to a chat request (accepted or dismissed)
        responseTime:
          type: string
          format: date-time
          readOnly: true
        createdTime:
          type: string
          format: date-time
          readOnly: true
        updatedTime:
          type: string
          format: date-time
          readOnly: true
        chatLogId:
          type: string
          format: uuid
          readOnly: true
          description: The chat log ID, set when the request is accepted

    ChatLog:
      type: object
      required:
        - id
        - chatRequestId
        - startTime
      properties:
        id:
          type: string
          format: uuid
        chatRequestId:
          type: string
          format: uuid
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
        endType:
          type: string
          enum: [user_exit, agreed_closure]

    ChatMessage:
      type: object
      required:
        - id
        - chatLogId
        - sender
        - type
        - content
        - sendTime
      properties:
        id:
          type: string
          format: uuid
        chatLogId:
          type: string
          format: uuid
        sender:
          $ref: '#/components/schemas/User'
        type:
          type: string
          enum: [text, agreed_position, agreed_closure]
        content:
          type: string
        targetId:
          type: string
          format: uuid
        sendTime:
          type: string
          format: date-time

    Survey:
      type: object
      required:
        - id
        - surveyTitle
        - createdTime
        - startTime
        - endTime
      properties:
        id:
          type: string
          format: uuid
        creator:
          $ref: '#/components/schemas/User'
        positionCategoryId:
          type: string
          format: uuid
        surveyTitle:
          type: string
        surveyType:
          type: string
          enum: [standard, pairwise]
        locationId:
          type: string
          format: uuid
          nullable: true
        locationCode:
          type: string
          nullable: true
        locationName:
          type: string
          nullable: true
        categoryId:
          type: string
          format: uuid
          nullable: true
        categoryName:
          type: string
          nullable: true
        questionCount:
          type: integer
        status:
          type: string
          enum: [active, inactive, deleted]
        isActive:
          type: boolean
        daysRemaining:
          type: integer
          nullable: true
        dateRange:
          type: object
          nullable: true
          properties:
            start:
              type: string
            end:
              type: string
        createdTime:
          type: string
          format: date-time
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
        questions:
          type: array
          items:
            $ref: '#/components/schemas/SurveyQuestion'

    UpdateSurveyRequest:
      type: object
      description: Request body for updating a survey. All fields are optional.
      properties:
        positionCategoryId:
          type: string
          format: uuid
        surveyTitle:
          type: string
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time

    SurveyQuestion:
      type: object
      required:
        - id
        - surveyId
        - question
        - options
      properties:
        id:
          type: string
          format: uuid
        surveyId:
          type: string
          format: uuid
        question:
          type: string
        options:
          type: array
          items:
            $ref: '#/components/schemas/SurveyQuestionOption'
        surveyTitle:
          type: string
          description: Title of the parent survey

    SurveyQuestionOption:
      type: object
      required:
        - id
        - surveyQuestionId
        - option
      properties:
        id:
          type: string
          format: uuid
        surveyQuestionId:
          type: string
          format: uuid
        option:
          type: string

    SurveyQuestionResponse:
      type: object
      required:
        - id
        - surveyQuestionOptionId
        - userId
        - responseTime
      properties:
        id:
          type: string
          format: uuid
        surveyQuestionOptionId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        responseTime:
          type: string
          format: date-time

    Report:
      type: object
      required:
        - id
        - reportType
        - targetId
        - submitterId
        - ruleId
        - status
      properties:
        id:
          type: string
          format: uuid
        reportType:
          type: string
          enum: [position, chat_log]
        targetId:
          type: string
          format: uuid
        submitterId:
          type: string
          format: uuid
        ruleId:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, dismissed, action_taken, deleted, spurious]
        submitterComment:
          type: string

    ModAction:
      type: object
      required:
        - id
        - reportId
        - responder
        - modResponse
      properties:
        id:
          type: string
          format: uuid
        reportId:
          type: string
          format: uuid
        responder:
          $ref: '#/components/schemas/User'
        modResponse:
          type: string
          enum: [dismiss, take_action, mark_spurious]
        modResponseText:
          type: string

    ModActionAppeal:
      type: object
      required:
        - id
        - userId
        - modActionId
        - appealText
        - appealState
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        modActionId:
          type: string
          format: uuid
        appealText:
          type: string
        appealState:
          type: string
          enum: [pending, approved, denied, escalated, modified, overruled]

    ModerationHistoryEvent:
      type: object
      required:
        - id
        - actionType
        - actionDate
        - moderator
      properties:
        id:
          type: string
          format: uuid
        actionType:
          type: string
          enum: [warning, temporary_ban, permanent_ban, removed, dismiss]
        actionDate:
          type: string
          format: date-time
        durationDays:
          type: integer
          nullable: true
          description: Duration in days for temporary bans
        rule:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
            title:
              type: string
        targetContent:
          type: string
          nullable: true
        reporter:
          type: object
          nullable: true
          properties:
            displayName:
              type: string
            username:
              type: string
        reportReason:
          type: string
          nullable: true
        moderator:
          type: object
          properties:
            displayName:
              type: string
            username:
              type: string
        moderatorComment:
          type: string
          nullable: true
        appealState:
          type: string
          nullable: true
          enum: [pending, approved, denied, escalated, modified, overruled]
        appealUser:
          type: object
          nullable: true
          properties:
            displayName:
              type: string
            username:
              type: string
        appealText:
          type: string
          nullable: true
        appealResponses:
          type: array
          nullable: true
          items:
            type: object
            properties:
              responder:
                type: object
                properties:
                  displayName:
                    type: string
                  username:
                    type: string
              responseText:
                type: string
              outcome:
                type: string
                nullable: true
                enum: [overruled, escalated, admin_decision]
                description: Role of this response in the appeal chain

    Kudos:
      type: object
      required:
        - id
        - chatLogId
      properties:
        id:
          type: string
          format: uuid
        sender:
          $ref: '#/components/schemas/User'
        senderUserId:
          type: string
          format: uuid
          description: ID of the user who sent the kudos
        receiverUserId:
          type: string
          format: uuid
          description: ID of the user who received the kudos
        chatLogId:
          type: string
          format: uuid
        createdTime:
          type: string
          format: date-time

    KudosCard:
      type: object
      required:
        - id
        - otherParticipant
        - closingStatement
        - chatEndTime
      properties:
        id:
          type: string
          format: uuid
          description: The chat_log_id (used for API calls)
        otherParticipant:
          $ref: '#/components/schemas/User'
        closingStatement:
          type: string
          description: The agreed closing statement from the chat
        chatEndTime:
          type: string
          format: date-time

    DemographicCard:
      type: object
      required:
        - field
        - question
        - options
      properties:
        field:
          type: string
          enum: [lean, education, geo_locale, sex]
        question:
          type: string
          description: Human-readable question
        options:
          type: array
          items:
            type: object
            required:
              - value
              - label
            properties:
              value:
                type: string
              label:
                type: string

    # Card queue wrapper schemas for discriminator support
    PositionCardItem:
      type: object
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [position]
        data:
          $ref: '#/components/schemas/Position'

    SurveyCardItem:
      type: object
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [survey]
        data:
          $ref: '#/components/schemas/SurveyQuestion'

    ChatRequestCardItem:
      type: object
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [chat_request]
        data:
          $ref: '#/components/schemas/ChatRequest'

    KudosCardItem:
      type: object
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [kudos]
        data:
          $ref: '#/components/schemas/KudosCard'

    DemographicCardItem:
      type: object
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [demographic]
        data:
          $ref: '#/components/schemas/DemographicCard'

    PairwiseCardItem:
      type: object
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [pairwise]
        data:
          $ref: '#/components/schemas/PairwiseComparison'

    BanNotificationCardItem:
      type: object
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [ban_notification]
        data:
          type: object
          properties:
            banType:
              type: string
              enum: [permanent_ban, temporary_ban]
            reason:
              type: string
              nullable: true
            ruleTitle:
              type: string
              nullable: true
            modActionId:
              type: string
              format: uuid
              nullable: true
            expiresAt:
              type: string
              format: date-time
              nullable: true
            hasAppealed:
              type: boolean
              nullable: true
            targetContent:
              type: object
              nullable: true
              description: The content (position or chat) that triggered the ban
              properties:
                type:
                  type: string
                  enum: [position, chat_log]
                statement:
                  type: string
                  nullable: true
                positionStatement:
                  type: string
                  nullable: true
                category:
                  type: object
                  nullable: true
                  properties:
                    id:
                      type: string
                    label:
                      type: string
                location:
                  type: object
                  nullable: true
                  properties:
                    code:
                      type: string
                    name:
                      type: string
                creator:
                  type: object
                  nullable: true
                participants:
                  type: array
                  nullable: true
                  items:
                    type: object
            actionChain:
              type: object
              nullable: true
              description: Privacy-filtered action chain for this ban
              properties:
                actionType:
                  type: string
                actionDate:
                  type: string
                  format: date-time
                  nullable: true
                durationDays:
                  type: integer
                  nullable: true
                ruleTitle:
                  type: string
                  nullable: true
                moderatorComment:
                  type: string
                  nullable: true
                appealState:
                  type: string
                  nullable: true
                  enum: [pending, approved, denied, escalated, modified, overruled]
                appealText:
                  type: string
                  nullable: true
                appealResponses:
                  type: array
                  nullable: true
                  items:
                    type: object
                    properties:
                      role:
                        type: string
                      responseText:
                        type: string
                        nullable: true
                      outcome:
                        type: string
                        nullable: true

    PositionRemovedCardItem:
      type: object
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [position_removed_notification]
        data:
          type: object
          properties:
            userPositionId:
              type: string
              format: uuid
            positionId:
              type: string
              format: uuid
            statement:
              type: string
            category:
              type: string
              nullable: true
            location:
              type: string
              nullable: true

    AdminResponseNotificationCardItem:
      type: object
      required:
        - type
        - data
      properties:
        type:
          type: string
          enum: [admin_response_notification]
        data:
          type: object
          properties:
            modActionAppealId:
              type: string
              format: uuid
            appealState:
              type: string
              enum: [approved, denied, modified]
            adminResponseText:
              type: string
              nullable: true
            adminResponder:
              type: object
              nullable: true
              properties:
                id:
                  type: string
                  format: uuid
                username:
                  type: string
                displayName:
                  type: string
                status:
                  type: string
                avatarUrl:
                  type: string
                  nullable: true
                avatarIconUrl:
                  type: string
                  nullable: true
            originalAction:
              type: object
              nullable: true
              properties:
                responder:
                  type: object
                  nullable: true
                  properties:
                    id:
                      type: string
                      format: uuid
                    username:
                      type: string
                    displayName:
                      type: string
                    status:
                      type: string
                    avatarUrl:
                      type: string
                      nullable: true
                    avatarIconUrl:
                      type: string
                      nullable: true
                modResponse:
                  type: string
                modResponseText:
                  type: string
                  nullable: true
                actions:
                  type: array
                  items:
                    type: object
                    properties:
                      userClass:
                        type: string
                      action:
                        type: string
                      durationDays:
                        type: integer
                        nullable: true
                        description: Duration in days for temporary bans
            priorResponses:
              type: array
              items:
                type: object
                properties:
                  responder:
                    type: object
                    nullable: true
                    properties:
                      id:
                        type: string
                        format: uuid
                      username:
                        type: string
                      displayName:
                        type: string
                      status:
                        type: string
                      avatarUrl:
                        type: string
                        nullable: true
                      avatarIconUrl:
                        type: string
                        nullable: true
                  responseText:
                    type: string
                    nullable: true

    PairwiseComparison:
      type: object
      required:
        - surveyId
        - surveyTitle
        - question
        - optionA
        - optionB
      properties:
        surveyId:
          type: string
          format: uuid
        surveyTitle:
          type: string
        question:
          type: string
        optionA:
          type: object
          required:
            - id
            - text
          properties:
            id:
              type: string
              format: uuid
            text:
              type: string
        optionB:
          type: object
          required:
            - id
            - text
          properties:
            id:
              type: string
              format: uuid
            text:
              type: string

    CreatePairwiseSurveyRequest:
      type: object
      required:
        - surveyTitle
        - items
        - startTime
        - endTime
      properties:
        surveyTitle:
          type: string
        items:
          type: array
          minItems: 2
          maxItems: 20
          items:
            type: string
          description: Pool of items to compare
        comparisonQuestion:
          type: string
          default: "Which better describes your views?"
        polisConversationId:
          type: string
          description: Link to Polis conversation for group labeling
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time

    PairwiseRankingResult:
      type: object
      properties:
        surveyId:
          type: string
          format: uuid
        surveyTitle:
          type: string
        totalResponses:
          type: integer
        totalRespondents:
          type: integer
          description: Number of unique users who responded
        rankings:
          type: array
          items:
            $ref: '#/components/schemas/ItemRanking'
        groupRankings:
          type: object
          description: Rankings broken down by Polis group ID
          additionalProperties:
            type: object
            properties:
              groupLabel:
                type: string
              memberCount:
                type: integer
              rankings:
                type: array
                items:
                  $ref: '#/components/schemas/ItemRanking'

    ItemRanking:
      type: object
      properties:
        itemId:
          type: string
          format: uuid
        itemText:
          type: string
        rank:
          type: integer
        winCount:
          type: integer
        comparisonCount:
          type: integer

    PairwiseSurvey:
      type: object
      properties:
        id:
          type: string
          format: uuid
        surveyTitle:
          type: string
        surveyType:
          type: string
          enum: [standard, pairwise]
        comparisonQuestion:
          type: string
        polisConversationId:
          type: string
        locationId:
          type: string
          format: uuid
          nullable: true
        locationCode:
          type: string
          nullable: true
        locationName:
          type: string
          nullable: true
        categoryId:
          type: string
          format: uuid
          nullable: true
        categoryName:
          type: string
          nullable: true
        items:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              text:
                type: string
              order:
                type: integer
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
        status:
          type: string
          enum: [active, inactive, deleted]
        isActive:
          type: boolean
        daysRemaining:
          type: integer
          nullable: true
        dateRange:
          type: object
          nullable: true
          properties:
            start:
              type: string
            end:
              type: string
        createdTime:
          type: string
          format: date-time

#    Location:
#      type: object
#      required:
#        - id
#        - name
#      properties:
#        id:
#          type: string
#          format: uuid
#        parentId:
#          type: string
#          format: uuid
#          description: ID of the parent location (null for top-level locations)
#        children:
#          type: array
#          items:
#            $ref: '#/components/schemas/Location'
#        code:
#          type: string
#        name:
#          type: string
#        affiliations:
#          type: array
#          items:
#            $ref: '#/components/schemas/Affiliation'

#    Affiliation:
#      type: object
#      required:
#        - id
#        - locationId
#        - name
#      properties:
#        id:
#          type: string
#          format: uuid
#        locationId:
#          type: string
#          format: uuid
#        name:
#          type: string

    Rule:
      type: object
      required:
        - id
        - title
        - text
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        text:
          type: string

    ModActionAppealResponse:
      type: object
      required:
        - id
        - modActionAppealId
        - responder
        - appealResponseText
        - response
      properties:
        id:
          type: string
          format: uuid
        modActionAppealId:
          type: string
          format: uuid
        responder:
          $ref: '#/components/schemas/User'
        appealResponseText:
          type: string
        response:
          type: string
          enum: [approve, deny, modify, accept, escalate]

    ModActionRequest:
      type: object
      required:
        - modResponse
      properties:
        modResponse:
          type: string
          enum: [dismiss, take_action, mark_spurious]
        modResponseText:
          type: string
          description: Required when modResponse is dismiss or take_action
        actions:
          type: array
          description: Required when modResponse is take_action
          items:
            type: object
            required:
              - userClass
              - action
            properties:
              userClass:
                type: string
                enum: [submitter, active_adopter, passive_adopter]
              action:
                type: string
                enum: [permanent_ban, temporary_ban, warning, removed]
              duration:
                type: integer
                description: Duration in days for temporary bans

    CreateSurveyRequest:
      type: object
      required:
        - surveyTitle
        - startTime
        - endTime
        - questions
      properties:
        positionCategoryId:
          type: string
          format: uuid
        surveyTitle:
          type: string
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
        questions:
          type: array
          items:
            type: object
            required:
              - question
              - options
            properties:
              question:
                type: string
              options:
                type: array
                items:
                  type: string

    PositionResponse:
      type: object
      required:
        - responses
      properties:
        responses:
          type: array
          items:
            type: object
            required:
              - positionId
              - response
            properties:
              positionId:
                type: string
                format: uuid
              response:
                type: string
                enum: [agree, disagree, pass]

    SimilarPositionResult:
      type: object
      required:
        - position
        - similarity
      properties:
        position:
          $ref: '#/components/schemas/Position'
        similarity:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Semantic similarity score (0-1)

    StatsResponse:
      type: object
      properties:
        conversationId:
          type: string
          description: The Polis conversation ID
        polisReportUrl:
          type: string
          nullable: true
          description: URL to the Polis report for this conversation
        computedAt:
          type: string
          format: date-time
          description: When the stats were computed
        groups:
          type: array
          items:
            $ref: '#/components/schemas/OpinionGroup'
        userPosition:
          type: object
          nullable: true
          properties:
            x:
              type: number
            y:
              type: number
            groupId:
              type: string
        positions:
          type: array
          items:
            $ref: '#/components/schemas/GroupPosition'
        userVotes:
          type: object
          additionalProperties:
            type: string
            enum: [agree, disagree, pass]
          description: Map of position IDs to user's vote (agree/disagree/pass)
          nullable: true
        userPositionIds:
          type: array
          items:
            type: string
          description: IDs of positions created by the current user
          nullable: true

    OpinionGroup:
      type: object
      properties:
        id:
          type: string
        label:
          type: string
        customLabel:
          type: string
          nullable: true
          description: Custom label from pairwise labeling survey
        labelWins:
          type: integer
          nullable: true
          description: Number of votes for the custom label
        labelRankings:
          type: array
          nullable: true
          description: All labels ranked by votes for this group
          items:
            type: object
            properties:
              label:
                type: string
              wins:
                type: integer
        memberCount:
          type: integer
        hull:
          type: array
          items:
            type: object
            properties:
              x:
                type: number
              y:
                type: number
        centroid:
          type: object
          properties:
            x:
              type: number
            y:
              type: number

    GroupPosition:
      type: object
      properties:
        id:
          type: string
        statement:
          type: string
        category:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
              nullable: true
            label:
              type: string
        location:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
              nullable: true
            name:
              type: string
            code:
              type: string
        creator:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
            displayName:
              type: string
            username:
              type: string
            userType:
              type: string
            trustScore:
              type: number
            avatarUrl:
              type: string
              nullable: true
            avatarIconUrl:
              type: string
              nullable: true
            kudosCount:
              type: integer
        groupId:
          type: string
          nullable: true
        voteDistribution:
          type: object
          properties:
            agree:
              type: number
            disagree:
              type: number
            pass:
              type: number
        totalVotes:
          type: integer
          description: Total number of votes across all groups
        groupVotes:
          type: object
          description: Vote distributions per group
          additionalProperties:
            type: object
            properties:
              agree:
                type: number
              disagree:
                type: number
              pass:
                type: number
        isDefining:
          type: boolean
        representativeness:
          type: number
        consensusType:
          type: string
          nullable: true
          enum: [agree, disagree]
          description: Whether this is a consensus agree or disagree position
        consensusScore:
          type: number
          nullable: true
          description: Strength of consensus (0-1)
        closureCount:
          type: integer
          description: Number of agreed closures for this position

    GroupDemographics:
      type: object
      description: Aggregated demographics for an opinion group
      properties:
        groupId:
          type: string
          description: The group ID
        groupLabel:
          type: string
          description: The group label (A, B, C, etc.)
        memberCount:
          type: integer
          description: Total members in the group
        respondentCount:
          type: integer
          description: Members with demographic data
        lean:
          type: object
          description: Political lean distribution
          additionalProperties:
            type: integer
        education:
          type: object
          description: Education level distribution
          additionalProperties:
            type: integer
        geoLocale:
          type: object
          description: Geographic locale distribution (urban/suburban/rural)
          additionalProperties:
            type: integer
        sex:
          type: object
          description: Sex distribution
          additionalProperties:
            type: integer
        race:
          type: object
          description: Race distribution
          additionalProperties:
            type: integer
        ageRange:
          type: object
          description: Age range distribution
          additionalProperties:
            type: integer
        incomeRange:
          type: object
          description: Income range distribution
          additionalProperties:
            type: integer

    AgreedClosuresResponse:
      type: object
      description: Response containing position info, opinion groups, and agreed closures
      required:
        - position
        - groups
        - closures
      properties:
        position:
          type: object
          required:
            - id
            - statement
          properties:
            id:
              type: string
              format: uuid
            statement:
              type: string
            category:
              type: object
              nullable: true
              properties:
                id:
                  type: string
                  format: uuid
                label:
                  type: string
            location:
              type: object
              nullable: true
              properties:
                id:
                  type: string
                  format: uuid
                code:
                  type: string
                name:
                  type: string
            creator:
              type: object
              nullable: true
              properties:
                id:
                  type: string
                  format: uuid
                displayName:
                  type: string
                userType:
                  type: string
                trustScore:
                  type: number
                  format: float
                  nullable: true
                avatarUrl:
                  type: string
                  nullable: true
                avatarIconUrl:
                  type: string
                  nullable: true
                kudosCount:
                  type: integer
        groups:
          type: array
          description: Opinion groups (same as StatsResponse.groups) for map visualization
          items:
            $ref: '#/components/schemas/OpinionGroup'
        allCategoriesGroups:
          type: array
          description: Opinion groups for the location-wide (all categories) Polis conversation
          items:
            $ref: '#/components/schemas/OpinionGroup'
        closures:
          type: array
          items:
            $ref: '#/components/schemas/AgreedClosure'

    AgreedClosure:
      type: object
      description: A single agreed closure from a chat
      required:
        - chatLogId
        - closedAt
        - positionHolderUser
        - initiatorUser
      properties:
        chatLogId:
          type: string
          format: uuid
        closureText:
          nullable: true
          description: The agreed closure proposal object
          allOf:
            - $ref: '#/components/schemas/AgreedPositionProposal'
        closedAt:
          type: string
          format: date-time
        hasAgreedStatements:
          type: boolean
          description: True if chat has more agreed statements beyond the closure
        mutualKudos:
          type: boolean
          description: True if both users sent kudos to each other
        crossGroup:
          type: boolean
          description: True if users are in different opinion groups
        positionHolderUser:
          $ref: '#/components/schemas/ClosureUserInfo'
          description: The user who held/proposed the position
        initiatorUser:
          $ref: '#/components/schemas/ClosureUserInfo'
          description: The user who initiated the chat (opposer)

    ClosureUserInfo:
      type: object
      description: User info for display in closure cards
      required:
        - id
        - displayName
        - username
      properties:
        id:
          type: string
          format: uuid
        displayName:
          type: string
        username:
          type: string
        avatarUrl:
          type: string
          nullable: true
        avatarIconUrl:
          type: string
          nullable: true
        trustScore:
          type: number
          format: float
          nullable: true
        kudosCount:
          type: integer
          nullable: true
        sentKudos:
          type: boolean
          description: Whether this user sent kudos to the other participant
        opinionGroup:
          type: object
          nullable: true
          description: The user's opinion group assignment (if available)
          properties:
            id:
              type: string
            label:
              type: string
        mapPosition:
          type: object
          nullable: true
          description: The user's x,y position on the opinion map (if available)
          properties:
            x:
              type: number
            y:
              type: number
        allCategoriesMapPosition:
          type: object
          nullable: true
          description: The user's x,y position on the all-categories opinion map
          properties:
            x:
              type: number
            y:
              type: number

    ChatLogBlob:
      type: object
      description: The JSONB blob stored in the chat_log.log column (camelCase keys)
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/ChatLogMessage'
        agreedPositions:
          type: array
          items:
            $ref: '#/components/schemas/AgreedPositionProposal'
        agreedClosure:
          $ref: '#/components/schemas/AgreedPositionProposal'
          nullable: true
        endedByUserId:
          type: string
          format: uuid
          description: ID of the user who ended the chat
        exportTime:
          type: string
          format: date-time
          description: When the chat log was exported from the chat server

    ChatLogMessage:
      type: object
      description: Individual message in a chat log blob
      required:
        - id
        - senderId
        - content
        - timestamp
      properties:
        id:
          type: string
        senderId:
          type: string
          format: uuid
        content:
          type: string
        timestamp:
          type: string
          format: date-time
        type:
          type: string
          enum: [message, system]

    AgreedPositionProposal:
      type: object
      description: An agreed position or closure proposal in a chat
      required:
        - content
      properties:
        id:
          type: string
        proposerId:
          type: string
          format: uuid
        content:
          type: string
        status:
          type: string
          enum: [proposed, accepted, rejected]
        isClosure:
          type: boolean
          description: True if this is a closure proposal (vs an agreed position)
        timestamp:
          type: string
          format: date-time

    GetChatLogResponse:
      type: object
      description: Full chat log response with metadata
      required:
        - id
        - chatRequestId
        - startTime
        - status
      properties:
        id:
          type: string
          format: uuid
        chatRequestId:
          type: string
          format: uuid
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
          nullable: true
        log:
          $ref: '#/components/schemas/ChatLogBlob'
          nullable: true
        endType:
          type: string
          enum: [user_exit, agreed_closure]
          nullable: true
        status:
          type: string
          enum: [active, archived, deleted]
        position:
          $ref: '#/components/schemas/Position'
        otherUser:
          $ref: '#/components/schemas/User'
        endedByUserId:
          type: string
          format: uuid
          nullable: true
          description: ID of the user who ended the chat

    ErrorModel:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
        details:
          type: object

    DemographicCrosstab:
      type: object
      properties:
        category:
          type: string
          description: The demographic category value (e.g., "male", "liberal", "urban")
        categoryLabel:
          type: string
          description: Human-readable label for the category
        totalInCategory:
          type: integer
          description: Total respondents in this demographic category
        optionBreakdown:
          type: array
          description: Response counts for each option within this demographic
          items:
            type: object
            properties:
              optionId:
                type: string
                format: uuid
              count:
                type: integer
              percentage:
                type: number
                format: float

    WebSocketEvent:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          description: Type of WebSocket event
        payload:
          type: object
          description: Event-specific payload

    ChatMessageEvent:
      allOf:
        - $ref: '#/components/schemas/WebSocketEvent'
        - type: object
          properties:
            type:
              enum: [message]
            payload:
              $ref: '#/components/schemas/ChatMessage'

    ChatTypingEvent:
      allOf:
        - $ref: '#/components/schemas/WebSocketEvent'
        - type: object
          properties:
            type:
              enum: [typing]
            payload:
              type: object
              required:
                - chatId
                - isTyping
              properties:
                chatId:
                  type: string
                isTyping:
                  type: boolean

    ChatStatusEvent:
      allOf:
        - $ref: '#/components/schemas/WebSocketEvent'
        - type: object
          properties:
            type:
              enum: [status]
            payload:
              type: object
              required:
                - chatId
                - status
              properties:
                chatId:
                  type: string
                status:
                  type: string
                  enum: [active, ended, user_left]

    MessageReadEvent:
      allOf:
        - $ref: '#/components/schemas/WebSocketEvent'
        - type: object
          properties:
            type:
              enum: [message_read]
            payload:
              type: object
              required:
                - chatId
                - messageIds
                - timestamp
              properties:
                chatId:
                  type: string
                messageIds:
                  type: array
                  items:
                    type: string
                  description: IDs of the messages that have been read
                agreedPositionIds:
                  type: array
                  items:
                    type: string
                  description: IDs of the agreed positions that have been read
                timestamp:
                  type: string
                  format: date-time
                  description: Time when the messages were read

    ChatRequestEvent:
      allOf:
        - $ref: '#/components/schemas/WebSocketEvent'
        - type: object
          properties:
            type:
              enum: [chat_request]
            payload:
              $ref: '#/components/schemas/ChatRequest'

    AgreedPositionEvent:
      allOf:
        - $ref: '#/components/schemas/WebSocketEvent'
        - type: object
          properties:
            type:
              enum: [agreed_position]
            payload:
              type: object
              required:
                - chatId
                - action
              properties:
                chatId:
                  type: string
                action:
                  type: string
                  enum: [propose, accept, reject, modify]
                proposalId:
                  type: string
                  description: Required when action is accept, reject, or modify
                content:
                  type: string
                  description: Required when action is propose or modify

    ChattingListItem:
      type: object
      required:
        - id
        - positionId
        - isActive
        - addedTime
      properties:
        id:
          type: string
          format: uuid
        positionId:
          type: string
          format: uuid
        position:
          $ref: '#/components/schemas/Position'
        isActive:
          type: boolean
        addedTime:
          type: string
          format: date-time
        lastChatTime:
          type: string
          format: date-time
          nullable: true
        chatCount:
          type: integer
        pendingRequestCount:
          type: integer
          description: Number of pending chat requests for this position

security:
  - BearerAuth: []

paths:
  /auth/register:
    post:
      operationId: registerUser
      summary: Register a new user
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - displayName
                - password
              properties:
                username:
                  type: string
                displayName:
                  type: string
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CurrentUser'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /admin/surveys/{surveyId}:
    get:
      operationId: getSurveyByIdAdmin
      summary: Get a specific survey (admin access)
      tags:
        - Admin
      parameters:
        - name: surveyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Survey details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Survey'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Survey not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
    patch:
      operationId: updateSurvey
      summary: Update a survey
      tags:
        - Admin
      parameters:
        - name: surveyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSurveyRequest'
      responses:
        '200':
          description: Survey updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Survey'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Survey not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
    delete:
      operationId: deleteSurvey
      summary: Delete a survey
      tags:
        - Admin
      parameters:
        - name: surveyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Survey deleted successfully
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Survey not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /auth/login:
    post:
      operationId: loginUser
      summary: Log in a user
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    $ref: '#/components/schemas/CurrentUser'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /auth/social/google:
    post:
      operationId: loginWithGoogle
      summary: Log in or register with Google
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    $ref: '#/components/schemas/CurrentUser'
        '401':
          description: Invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /auth/social/facebook:
    post:
      operationId: loginWithFacebook
      summary: Log in or register with Facebook
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    $ref: '#/components/schemas/CurrentUser'
        '401':
          description: Invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /card-queue:
    get:
      operationId: getCardQueue
      summary: Get mixed queue of positions, surveys, chat requests, kudos, and demographics
      tags:
        - Cards
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            maximum: 50
          description: Maximum number of cards to return
      responses:
        '200':
          description: Mixed queue of cards. Priority cards (chat_request, kudos) appear at front, followed by shuffled pool (demographic, survey, position).
          content:
            application/json:
              schema:
                type: array
                items:
                  oneOf:
                    - $ref: '#/components/schemas/PositionCardItem'
                    - $ref: '#/components/schemas/SurveyCardItem'
                    - $ref: '#/components/schemas/ChatRequestCardItem'
                    - $ref: '#/components/schemas/KudosCardItem'
                    - $ref: '#/components/schemas/DemographicCardItem'
                    - $ref: '#/components/schemas/PairwiseCardItem'
                    - $ref: '#/components/schemas/BanNotificationCardItem'
                    - $ref: '#/components/schemas/PositionRemovedCardItem'
                  discriminator:
                    propertyName: type
                    mapping:
                      position: '#/components/schemas/PositionCardItem'
                      survey: '#/components/schemas/SurveyCardItem'
                      chat_request: '#/components/schemas/ChatRequestCardItem'
                      kudos: '#/components/schemas/KudosCardItem'
                      demographic: '#/components/schemas/DemographicCardItem'
                      pairwise: '#/components/schemas/PairwiseCardItem'
                      ban_notification: '#/components/schemas/BanNotificationCardItem'
                      position_removed_notification: '#/components/schemas/PositionRemovedCardItem'

  /cards/notifications/{positionId}/dismiss:
    post:
      operationId: dismissPositionRemovedNotification
      summary: Dismiss a position removed notification
      tags:
        - Cards
      parameters:
        - name: positionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Notification dismissed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string

  /moderation/notifications/{appealId}/dismiss-admin-response:
    post:
      operationId: dismissAdminResponseNotification
      summary: Dismiss an admin response notification
      tags:
        - Moderation
      parameters:
        - name: appealId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Notification dismissed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string

  /positions:
    post:
      operationId: createPosition
      summary: Create a new position statement
      tags:
        - Positions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - statement
                - categoryId
                - locationId
              properties:
                statement:
                  type: string
                  maxLength: 140
                  description: The position statement (max 140 characters for Polis compatibility)
                categoryId:
                  type: string
                  format: uuid
                locationId:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Position created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Position'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /positions/{positionId}:
    get:
      operationId: getPositionById
      summary: Get a specific position statement
      tags:
        - Positions
      parameters:
        - name: positionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Position statement details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Position'
        '404':
          description: Position not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /positions/{positionId}/adopt:
    post:
      operationId: adoptPosition
      summary: Adopt a position and register an agree response
      description: Creates a user_position entry for the current user and registers an agree response
      tags:
        - Positions
      parameters:
        - name: positionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '201':
          description: Position adopted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPosition'
        '400':
          description: Position already adopted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Position not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /positions/{positionId}/agreed-closures:
    get:
      operationId: getPositionAgreedClosures
      summary: Get all agreed closures for chats about a position
      description: |
        Returns all chats that ended with an agreed closure for the specified position.
        Results are sorted by priority: mutual kudos + cross-group first, then cross-group only,
        then mutual kudos only, then by date.
      tags:
        - Positions
      parameters:
        - name: positionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of agreed closures with position and group info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgreedClosuresResponse'
        '404':
          description: Position not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /positions/response:
    post:
      operationId: respondToPositions
      summary: Respond to one or more position statements
      tags:
        - Positions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PositionResponse'
      responses:
        '200':
          description: Responses recorded successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Response'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /positions/search:
    post:
      operationId: searchSimilarPositions
      summary: Search for positions with similar meaning
      description: Uses semantic similarity to find existing positions that match the given statement
      tags:
        - Positions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - statement
              properties:
                statement:
                  type: string
                  description: The statement to find similar positions for
                  minLength: 20
                categoryId:
                  type: string
                  format: uuid
                  description: Optional category filter
                locationId:
                  type: string
                  format: uuid
                  description: Optional location filter
                limit:
                  type: integer
                  default: 5
                  minimum: 1
                  maximum: 10
                  description: Maximum number of similar positions to return
      responses:
        '200':
          description: Similar positions found
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SimilarPositionResult'
        '400':
          description: Invalid input (e.g., statement too short)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /positions/{positionId}/report:
    post:
      operationId: reportPosition
      summary: Report a position statement
      tags:
        - Moderation
      parameters:
        - name: positionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ruleId
              properties:
                ruleId:
                  type: string
                  format: uuid
                comment:
                  type: string
                  maxLength: 255
      responses:
        '201':
          description: Report submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /avatars:
    get:
      operationId: getAvailableAvatars
      summary: Get list of available avatar options
      tags:
        - Users
      security: []
      responses:
        '200':
          description: List of available avatars
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required:
                    - id
                    - url
                    - name
                  properties:
                    id:
                      type: string
                    url:
                      type: string
                      format: uri
                    name:
                      type: string

  /users/me:
    get:
      operationId: getCurrentUser
      summary: Get current user profile
      tags:
        - Users
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CurrentUser'
    patch:
      operationId: updateUserProfile
      summary: Update current user profile (displayName, email, avatarUrl)
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                displayName:
                  type: string
                email:
                  type: string
                  format: email
                avatarUrl:
                  type: string
                  format: uri
                  nullable: true
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CurrentUser'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/password:
    put:
      operationId: changePassword
      summary: Change current user's password
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - currentPassword
                - newPassword
              properties:
                currentPassword:
                  type: string
                newPassword:
                  type: string
                  minLength: 8
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Invalid input (new password too short)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '401':
          description: Current password incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/avatar:
    post:
      operationId: uploadAvatar
      summary: Upload a custom avatar image
      description: |
        Upload a base64 encoded image as avatar. The image will be validated for:
        - File size (max 5MB)
        - Valid image format (JPEG, PNG, WebP, GIF)
        - NSFW content (rejected if detected)
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - imageBase64
              properties:
                imageBase64:
                  type: string
                  description: Base64 encoded image data (with or without data URI prefix)
      responses:
        '200':
          description: Avatar uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  avatarUrl:
                    type: string
                    description: Full size avatar (256x256) as base64 data URI
                  avatarIconUrl:
                    type: string
                    description: Icon size avatar (64x64) as base64 data URI
                  message:
                    type: string
        '400':
          description: Invalid image or NSFW content detected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/delete:
    post:
      operationId: deleteCurrentUser
      summary: Soft delete current user account
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - password
              properties:
                password:
                  type: string
      responses:
        '200':
          description: Account deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '401':
          description: Password incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/heartbeat:
    post:
      operationId: heartbeat
      summary: Record user heartbeat for presence tracking
      tags:
        - Users
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Heartbeat recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string

  /users/me/push-token:
    post:
      operationId: registerPushToken
      summary: Register a push notification token
      tags:
        - Users
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
                  description: Expo push token
                platform:
                  type: string
                  enum: [expo, web]
                  default: expo
      responses:
        '200':
          description: Token registered
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string

  /users/me/settings:
    get:
      operationId: getUserSettings
      summary: Get current user settings
      tags:
        - Users
      responses:
        '200':
          description: User settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSettings'
    put:
      operationId: updateUserSettings
      summary: Update current user settings
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserSettings'
      responses:
        '200':
          description: Settings updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSettings'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/demographics:
    get:
      operationId: getUserDemographics
      summary: Get current user demographics
      tags:
        - Users
      responses:
        '200':
          description: User demographics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDemographics'
    put:
      operationId: updateUserDemographics
      summary: Replace user demographics
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserDemographics'
      responses:
        '200':
          description: Demographics updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDemographics'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
    patch:
      operationId: updateUserDemographicsPartial
      summary: Update specific user demographics fields
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserDemographics'
      responses:
        '200':
          description: Demographics updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDemographics'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/locations:
    get:
      operationId: getUserLocations
      summary: Get current user's locations with hierarchy
      description: Returns the user's locations ordered from highest level (e.g., country) to lowest level (e.g., city)
      tags:
        - Users
      responses:
        '200':
          description: List of user's locations in hierarchical order
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Location'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
    put:
      operationId: setUserLocation
      summary: Set the current user's location
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - locationId
              properties:
                locationId:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Updated location hierarchy
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Location'
        '400':
          description: Invalid location ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/positions:
    get:
      operationId: getCurrentUserPositions
      summary: Get current user's position statements
      tags:
        - Users
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive, all]
            default: active
          description: Filter by status. Use 'all' to include both active and inactive positions.
        - name: If-None-Match
          in: header
          required: false
          schema:
            type: string
          description: ETag from a previous response for conditional request
        - name: If-Modified-Since
          in: header
          required: false
          schema:
            type: string
          description: Last-Modified date from a previous response for conditional request
      responses:
        '200':
          description: List of user's position statements
          headers:
            ETag:
              schema:
                type: string
            Last-Modified:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserPosition'
        '304':
          description: Not Modified - cached version is still valid

  /users/me/positions/metadata:
    get:
      operationId: getCurrentUserPositionsMetadata
      summary: Get metadata about user's positions for cache validation
      description: Returns lightweight metadata (count and last updated time) to check if full position list needs to be refetched
      tags:
        - Users
      responses:
        '200':
          description: Position list metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                    description: Total number of positions for this user
                  lastUpdatedTime:
                    type: string
                    format: date-time
                    nullable: true
                    description: Most recent position creation or update time
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/positions/{userPositionId}:
    patch:
      operationId: updateUserPosition
      summary: Update a user position (toggle active/inactive)
      tags:
        - Users
      parameters:
        - name: userPositionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [active, inactive]
      responses:
        '200':
          description: Position updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPosition'
        '400':
          description: Invalid status value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Position not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
    delete:
      operationId: deleteUserPosition
      summary: Delete a user position (soft delete)
      tags:
        - Users
      parameters:
        - name: userPositionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Position deleted
        '404':
          description: Position not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/chatting-list:
    get:
      operationId: getChattingList
      summary: Get user's chatting list positions
      description: Returns positions the user has swiped up on and wants to continue chatting about
      tags:
        - ChattingList
      parameters:
        - name: If-None-Match
          in: header
          required: false
          schema:
            type: string
          description: ETag from a previous response for conditional request
        - name: If-Modified-Since
          in: header
          required: false
          schema:
            type: string
          description: Last-Modified date from a previous response for conditional request
      responses:
        '200':
          description: List of chatting list items
          headers:
            ETag:
              schema:
                type: string
            Last-Modified:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChattingListItem'
        '304':
          description: Not Modified - cached version is still valid
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
    post:
      operationId: addToChattingList
      summary: Add a position to the chatting list
      tags:
        - ChattingList
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - positionId
              properties:
                positionId:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Position added to chatting list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChattingListItem'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '409':
          description: Position already in chatting list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/chatting-list/metadata:
    get:
      operationId: getChattingListMetadata
      summary: Get metadata about chatting list for cache validation
      description: Returns lightweight metadata (count and last updated time) to check if full chatting list needs to be refetched
      tags:
        - ChattingList
      responses:
        '200':
          description: Chatting list metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                    description: Total number of items in the chatting list
                  lastUpdatedTime:
                    type: string
                    format: date-time
                    nullable: true
                    description: Most recent chatting list modification time
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/chatting-list/{id}:
    patch:
      operationId: updateChattingListItem
      summary: Update a chatting list item (toggle active status)
      tags:
        - ChattingList
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                isActive:
                  type: boolean
      responses:
        '200':
          description: Chatting list item updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChattingListItem'
        '404':
          description: Chatting list item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
    delete:
      operationId: removeFromChattingList
      summary: Remove a position from the chatting list
      tags:
        - ChattingList
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Position removed from chatting list
        '404':
          description: Chatting list item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/chatting-list/explanation-seen:
    post:
      operationId: markChattingListExplanationSeen
      summary: Mark the chatting list explanation as seen
      tags:
        - ChattingList
      responses:
        '204':
          description: Explanation marked as seen
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/me/chatting-list/bulk-remove:
    post:
      operationId: bulkRemoveFromChattingList
      summary: Remove multiple positions from chatting list
      description: |
        Bulk remove chatting list items by category, location, or specific item IDs.
        At least one of categoryId, locationCode, or itemIds must be provided.
      tags:
        - ChattingList
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                categoryId:
                  type: string
                  format: uuid
                  description: Remove all items with positions in this category
                locationCode:
                  type: string
                  description: Remove all items with positions in this location
                itemIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: Specific chatting list item IDs to remove
      responses:
        '200':
          description: Items removed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  removedCount:
                    type: integer
                    description: Number of items removed
        '400':
          description: Invalid input - at least one filter required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /chats/requests/:
    post:
      operationId: createChatRequest
      summary: Request to chat about a position statement
      tags:
        - Chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '201':
          description: Chat request created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatRequest'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '403':
          description: Forbidden - cannot request chat with your own position
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /chats/requests/{requestId}:
    patch:
      operationId: respondToChatRequest
      summary: Respond to a chat request
      tags:
        - Chat
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Chat request updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatRequest'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

        '403':
          description: Forbidden - user was not the recipient of this chat request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Chat request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
    delete:
      operationId: rescindChatRequest
      summary: Rescind a chat request
      tags:
        - Chat
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Chat request updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatRequest'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '403':
          description: Forbidden - user was not the creator of this chat request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Chat request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'


  /chats/{chatId}/log:
    get:
      operationId: getChatLog
      summary: Get JSON blob of a chat log
      tags:
        - Chat
      description: |
        Retrieves a complete JSON blob of a chat log.
      parameters:
        - name: chatId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: If-None-Match
          in: header
          required: false
          schema:
            type: string
          description: ETag from a previous response for conditional request
        - name: If-Modified-Since
          in: header
          required: false
          schema:
            type: string
          description: Last-Modified date from a previous response for conditional request
      responses:
        '200':
          description: Complete chat log with metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetChatLogResponse'
          headers:
            ETag:
              schema:
                type: string
            Last-Modified:
              schema:
                type: string
        '304':
          description: Not Modified - cached version is still valid
        '403':
          description: Forbidden - user was not a participant in this chat
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Chat not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'


  /chats/{chatId}/report:
    post:
      operationId: reportChat
      summary: Report a chat
      tags:
        - Moderation
      parameters:
        - name: chatId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ruleId
              properties:
                ruleId:
                  type: string
                  format: uuid
                comment:
                  type: string
                  maxLength: 255
      responses:
        '201':
          description: Report submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '403':
          description: Forbidden - user was not a participant in this chat
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /chats/{chatId}/kudos:
    post:
      operationId: sendKudos
      summary: Send kudos to a user after a chat
      tags:
        - Chat
      parameters:
        - name: chatId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '201':
          description: Kudos sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Kudos'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '403':
          description: Forbidden - user was not a participant in this chat
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /chats/{chatId}/kudos/dismiss:
    post:
      operationId: dismissKudos
      summary: Dismiss a kudos prompt without sending kudos
      description: Records that the user dismissed the kudos prompt, preventing the kudos card from appearing again.
      tags:
        - Chat
      parameters:
        - name: chatId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Kudos dismissed successfully
        '403':
          description: Forbidden - user was not a participant in this chat
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Chat not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /chats/user/{userId}:
    get:
      operationId: getUserChats
      summary: Get a list of the user's historical chats
      tags:
        - Chat
        - Users
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: positionId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter chats by position ID
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
          description: Maximum number of chats to return
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Number of chats to skip
        - name: If-None-Match
          in: header
          required: false
          schema:
            type: string
          description: ETag from a previous response for conditional request
        - name: If-Modified-Since
          in: header
          required: false
          schema:
            type: string
          description: Last-Modified date from a previous response for conditional request
      responses:
        '200':
          description: List of user's historical chats
          headers:
            ETag:
              schema:
                type: string
            Last-Modified:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                      description: Chat ID
                    startTime:
                      type: string
                      format: date-time
                    endTime:
                      type: string
                      format: date-time
                    endType:
                      type: string
                      description: How the chat ended
                      enum: [agreed_closure, user_exit, timeout, disagreement]
                    status:
                      type: string
                      description: Current status of the chat
                      enum: [active, archived, deleted]
                    position:
                      $ref: '#/components/schemas/Position'
                    otherUser:
                      $ref: '#/components/schemas/User'
                    agreedClosure:
                      $ref: '#/components/schemas/AgreedPositionProposal'
                      nullable: true
                      description: The agreed closure object if the chat ended with one
                    endedByUserId:
                      type: string
                      format: uuid
                      nullable: true
                      description: ID of the user who ended the chat
                    kudosSent:
                      type: boolean
                      description: Whether the current user sent kudos to the other user for this chat
                    kudosReceived:
                      type: boolean
                      description: Whether the other user sent kudos to the current user for this chat
        '304':
          description: Not Modified - cached version is still valid

  /chats/user/{userId}/metadata:
    get:
      operationId: getUserChatsMetadata
      summary: Get metadata about user's chat history for cache validation
      description: Returns lightweight metadata (count and last activity time) to check if full chat list needs to be refetched
      tags:
        - Chat
        - Users
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Chat list metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                    description: Total number of chats for this user
                  lastActivityTime:
                    type: string
                    format: date-time
                    nullable: true
                    description: Most recent chat activity (start or end time)
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '403':
          description: Forbidden - cannot view other user's chats
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /categories:
    get:
      operationId: getAllCategories
      summary: Get hierarchical structure of all position categories and subcategories
      tags:
        - Categories
      responses:
        '200':
          description: Complete hierarchical structure of categories
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PositionCategory'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /categories/suggest:
    post:
      operationId: suggestCategory
      summary: Suggest categories based on a position statement
      description: Uses semantic similarity to rank categories by relevance to the given statement
      tags:
        - Categories
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - statement
              properties:
                statement:
                  type: string
                  description: The position statement to match against categories
                  minLength: 10
                limit:
                  type: integer
                  default: 3
                  minimum: 1
                  maximum: 10
      responses:
        '200':
          description: Ranked list of suggested categories
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    category:
                      $ref: '#/components/schemas/PositionCategory'
                    score:
                      type: number
                      format: float
                      description: Relevance score (0-1)
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /surveys:
    get:
      operationId: getActiveSurveys
      summary: Get a list of currently active surveys
      tags:
        - Surveys
      parameters:
        - name: locationId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Filter by location ID (includes parent locations)
        - name: categoryId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Filter by category ID
      responses:
        '200':
          description: List of active surveys
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Survey'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /surveys/{surveyId}:
    get:
      operationId: getSurveyById
      summary: Get a specific survey
      tags:
        - Surveys
      parameters:
        - name: surveyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Survey details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Survey'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Survey not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /surveys/{surveyId}/questions/{questionId}/response:
    post:
      operationId: respondToSurveyQuestion
      summary: Respond to a survey question
      tags:
        - Surveys
      parameters:
        - name: surveyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: questionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - optionId
              properties:
                optionId:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Response recorded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SurveyQuestionResponse'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /surveys/pairwise:
    get:
      operationId: getPairwiseSurveys
      summary: Get list of pairwise surveys
      description: Returns pairwise surveys, optionally filtered by location and category
      tags:
        - Surveys
      parameters:
        - name: locationId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by location ID
        - name: categoryId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by category ID
      responses:
        '200':
          description: List of pairwise surveys
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PairwiseSurvey'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /surveys/pairwise/{surveyId}/rankings:
    get:
      operationId: getSurveyRankings
      summary: Get rankings from a pairwise survey
      description: Returns overall rankings and per-group rankings if the survey is linked to a Polis conversation
      tags:
        - Surveys
      parameters:
        - name: surveyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: filterLocationId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Only include responses from users in this location
        - name: groupId
          in: query
          required: false
          schema:
            type: string
          description: Filter to users in this Polis group (0, 1, 2, etc.). If not provided or "majority", includes all users.
        - name: polisConversationId
          in: query
          required: false
          schema:
            type: string
          description: Polis conversation ID to use for group membership lookup. Falls back to survey's linked conversation.
      responses:
        '200':
          description: Survey rankings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PairwiseRankingResult'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Survey not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /surveys/{surveyId}/results:
    get:
      operationId: getStandardSurveyResults
      summary: Get results from a standard survey
      description: Returns response counts per option for each question
      tags:
        - Surveys
      parameters:
        - name: surveyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: filterLocationId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Only include responses from users in this location
        - name: groupId
          in: query
          required: false
          schema:
            type: string
          description: Filter to users in this Polis group (0, 1, 2, etc.). If not provided or "majority", includes all users.
        - name: polisConversationId
          in: query
          required: false
          schema:
            type: string
          description: Polis conversation ID to use for group membership lookup
      responses:
        '200':
          description: Survey results
          content:
            application/json:
              schema:
                type: object
                properties:
                  surveyId:
                    type: string
                    format: uuid
                  surveyTitle:
                    type: string
                  surveyLocationCode:
                    type: string
                  surveyLocationName:
                    type: string
                  totalRespondents:
                    type: integer
                  questions:
                    type: array
                    items:
                      type: object
                      properties:
                        questionId:
                          type: string
                          format: uuid
                        question:
                          type: string
                        totalResponses:
                          type: integer
                        options:
                          type: array
                          items:
                            type: object
                            properties:
                              optionId:
                                type: string
                                format: uuid
                              optionText:
                                type: string
                              responseCount:
                                type: integer
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Survey not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /surveys/{surveyId}/questions/{questionId}/crosstabs:
    get:
      operationId: getQuestionCrosstabs
      summary: Get demographic crosstabs for a survey question
      description: Returns response counts broken down by demographic categories
      tags:
        - Surveys
      parameters:
        - name: surveyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: questionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: filterLocationId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Only include responses from users in this location
        - name: groupId
          in: query
          required: false
          schema:
            type: string
          description: Filter to users in this Polis group (0, 1, 2, etc.)
        - name: polisConversationId
          in: query
          required: false
          schema:
            type: string
          description: Polis conversation ID for group membership lookup
      responses:
        '200':
          description: Demographic crosstabs for the question
          content:
            application/json:
              schema:
                type: object
                properties:
                  questionId:
                    type: string
                    format: uuid
                  questionText:
                    type: string
                  totalResponses:
                    type: integer
                  options:
                    type: array
                    items:
                      type: object
                      properties:
                        optionId:
                          type: string
                          format: uuid
                        optionText:
                          type: string
                        totalCount:
                          type: integer
                  demographics:
                    type: object
                    properties:
                      politicalLean:
                        type: array
                        items:
                          $ref: '#/components/schemas/DemographicCrosstab'
                      education:
                        type: array
                        items:
                          $ref: '#/components/schemas/DemographicCrosstab'
                      geoLocale:
                        type: array
                        items:
                          $ref: '#/components/schemas/DemographicCrosstab'
                      sex:
                        type: array
                        items:
                          $ref: '#/components/schemas/DemographicCrosstab'
                      affiliation:
                        type: array
                        items:
                          $ref: '#/components/schemas/DemographicCrosstab'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Survey or question not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /rules:
    get:
      operationId: getRules
      summary: Get all active community rules
      tags:
        - Moderation
      responses:
        '200':
          description: List of active rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Rule'

  /moderation/reports/{reportId}/response:
    post:
      operationId: takeModeratorAction
      summary: Take action on a report
      tags:
        - Moderation
      parameters:
        - name: reportId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModActionRequest'
      responses:
        '200':
          description: Action taken successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModAction'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /moderation/queue:
    get:
      operationId: getModerationQueue
      summary: Get unified moderation queue with all items requiring moderator attention
      tags:
        - Moderation
      responses:
        '200':
          description: List of all moderation items requiring attention
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required:
                    - type
                    - data
                  properties:
                    type:
                      type: string
                      enum: [report, appeal, admin_response_notification]
                    data:
                      oneOf:
                        - $ref: '#/components/schemas/Report'
                        - $ref: '#/components/schemas/ModActionAppeal'
                        - $ref: '#/components/schemas/AdminResponseNotificationCardItem'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /moderation/actions/{actionId}/appeal:
    post:
      operationId: createAppeal
      summary: Create an appeal for a moderation action
      tags:
        - Moderation
      parameters:
        - name: actionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - appealText
              properties:
                appealText:
                  type: string
                  maxLength: 1000
      responses:
        '201':
          description: Appeal created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModActionAppeal'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /moderation/appeals/{appealId}/response:
    post:
      operationId: respondToAppeal
      summary: Respond to a moderation appeal
      tags:
        - Moderation
      parameters:
        - name: appealId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - response
                - responseText
              properties:
                response:
                  type: string
                  enum: [approve, deny, modify, accept, escalate]
                responseText:
                  type: string
                actions:
                  type: array
                  description: Required when response is modify. Same format as ModActionRequest actions.
                  items:
                    type: object
                    required:
                      - userClass
                      - action
                    properties:
                      userClass:
                        type: string
                        enum: [submitter, active_adopter, passive_adopter]
                      action:
                        type: string
                        enum: [permanent_ban, temporary_ban, warning, removed]
                      duration:
                        type: integer
                        description: Duration in days for temporary bans
      responses:
        '200':
          description: Appeal response recorded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModActionAppealResponse'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /moderation/users/{userId}/history:
    get:
      operationId: getUserModerationHistory
      summary: Get moderation history for a user
      description: Returns all moderation actions taken against a user, sorted by most recent first. Requires moderator or admin role.
      tags:
        - Moderation
      security:
        - BearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of moderation history events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ModerationHistoryEvent'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /locations:
    get:
      operationId: getAllLocations
      summary: Get all locations as a flat list with hierarchy info
      tags:
        - Users
      responses:
        '200':
          description: Flat list of all locations with hierarchy info
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Location'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /users/{userId}:
    get:
      operationId: getUserById
      summary: Get a user by ID
      tags:
        - Users
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the user to retrieve
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '403':
          description: Forbidden - insufficient permissions to view this user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /admin/surveys:
    get:
      operationId: getSurveys
      summary: Get a list of surveys
      tags:
        - Admin
      parameters:
        - name: title
          in: query
          schema:
            type: string
          description: Filter surveys by title (partial match)
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive, all]
            default: all
          description: Filter surveys by active status
        - name: createdAfter
          in: query
          schema:
            type: string
            format: date-time
          description: Filter surveys created after this timestamp
        - name: createdBefore
          in: query
          schema:
            type: string
            format: date-time
          description: Filter surveys created before this timestamp
      responses:
        '200':
          description: List of surveys
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Survey'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
    post:
      operationId: createSurvey
      summary: Create a new survey
      tags:
        - Admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSurveyRequest'
      responses:
        '201':
          description: Survey created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Survey'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /admin/surveys/pairwise:
    post:
      operationId: createPairwiseSurvey
      summary: Create a pairwise comparison survey
      description: |
        Creates a survey where users compare items pairwise to generate rankings.
        Used for generating custom labels for opinion groups.
      tags:
        - Admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePairwiseSurveyRequest'
      responses:
        '201':
          description: Pairwise survey created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PairwiseSurvey'
        '400':
          description: Invalid input (e.g., fewer than 2 items)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /admin/surveys/{surveyId}/rankings:
    get:
      operationId: getPairwiseRankings
      summary: Get win-count rankings from pairwise survey
      description: |
        Returns rankings computed dynamically from pairwise responses.
        Can filter by Polis group ID to get per-group rankings based on current membership.
      tags:
        - Admin
      parameters:
        - name: surveyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: groupId
          in: query
          schema:
            type: string
          description: Filter by Polis group ID (uses current group membership)
      responses:
        '200':
          description: Pairwise rankings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PairwiseRankingResult'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Survey not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /pairwise/{surveyId}/respond:
    post:
      operationId: respondToPairwise
      summary: Submit a pairwise comparison response
      description: Records which item the user selected as the winner in a comparison
      tags:
        - Surveys
      parameters:
        - name: surveyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - winnerItemId
                - loserItemId
              properties:
                winnerItemId:
                  type: string
                  format: uuid
                  description: ID of the selected (winning) item
                loserItemId:
                  type: string
                  format: uuid
                  description: ID of the non-selected (losing) item
      responses:
        '200':
          description: Response recorded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Survey or item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /stats/{locationId}:
    get:
      operationId: getLocationStats
      summary: Get Polis opinion group statistics for all categories in a location
      tags:
        - Stats
      parameters:
        - name: locationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Opinion group statistics
          headers:
            Cache-Control:
              schema:
                type: string
            ETag:
              schema:
                type: string
            Last-Modified:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsResponse'
        '304':
          description: Not Modified - cached version is still valid
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Location not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /stats/{locationId}/{categoryId}:
    get:
      operationId: getStats
      summary: Get Polis opinion group statistics for a specific category
      tags:
        - Stats
      parameters:
        - name: locationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: categoryId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Opinion group statistics
          headers:
            Cache-Control:
              schema:
                type: string
            ETag:
              schema:
                type: string
            Last-Modified:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsResponse'
        '304':
          description: Not Modified - cached version is still valid
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Location or category not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /stats/{locationId}/{categoryId}/demographics/{groupId}:
    get:
      operationId: getGroupDemographics
      summary: Get demographic breakdown for an opinion group
      description: |
        Returns aggregated demographic data for members of a specific opinion group.
        Demographics include political lean, education, geographic locale, sex, and race.
      tags:
        - Stats
      parameters:
        - name: locationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: categoryId
          in: path
          required: true
          schema:
            type: string
          description: Category UUID or 'all' for all categories
        - name: groupId
          in: path
          required: true
          schema:
            type: string
          description: Group ID (0, 1, 2, etc.) or 'all' for all groups combined
      responses:
        '200':
          description: Group demographics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupDemographics'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '404':
          description: Location, category, or group not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /stats/report/{conversationId}:
    get:
      operationId: getPolisReport
      summary: Get Polis report for a conversation
      description: |
        Proxies the Polis report page for a conversation. Returns HTML content
        that can be displayed in an iframe or new browser tab. This endpoint is
        publicly accessible since reports contain only aggregate data.
      tags:
        - Stats
      security: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
          description: The Polis conversation ID
      responses:
        '200':
          description: Polis report HTML
          content:
            text/html:
              schema:
                type: string
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '502':
          description: Failed to fetch report from Polis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'

  /polis-asset/{path}:
    get:
      operationId: getPolisAsset
      summary: Proxy Polis static assets
      description: |
        Proxies static assets (JS, CSS, images) from the Polis server.
        Used by the Polis report page to load its dependencies.
      tags:
        - Stats
      security: []
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
          description: The asset path (e.g., "report_bundle.js")
      responses:
        '200':
          description: Asset content
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '404':
          description: Asset not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
        '502':
          description: Failed to fetch asset from Polis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
