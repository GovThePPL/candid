services:
    api:
        build:
            context: .
            dockerfile: backend/server/Dockerfile
        ports:
            - "8000:8000"
        environment:
            DATABASE_URL: postgresql://user:postgres@db:5432/candid
            FLASK_ENV: dev
            FLASK_APP: "app.app:create_app"
            # Keycloak
            KEYCLOAK_URL: http://keycloak:8180
            KEYCLOAK_REALM: candid
            KEYCLOAK_BACKEND_CLIENT_ID: candid-backend
            KEYCLOAK_BACKEND_CLIENT_SECRET: candid-backend-secret
            # Polis integration
            POLIS_API_URL: http://polis-server:5000/api/v3
            POLIS_BASE_URL: http://polis-server:5000
            POLIS_ENABLED: "true"
            POLIS_TIMEOUT: "10"
            # Polis admin (Keycloak ROPC via polis-admin client)
            POLIS_ADMIN_CLIENT_SECRET: polis-admin-secret
            POLIS_ADMIN_EMAIL: polis-admin@candid.dev
            POLIS_ADMIN_PASSWORD: "password"
            # Redis
            REDIS_URL: redis://redis:6379
            # Connection pooling
            DB_POOL_MIN: 4
            DB_POOL_MAX: 20
            # Worker processes (2x CPU cores is a good starting point)
            GUNICORN_WORKERS: 4
            # NLP service
            NLP_SERVICE_URL: http://nlp:5001
        healthcheck:
            test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/ui/')\" || exit 1"]
            interval: 10s
            timeout: 5s
            start_period: 15s
            retries: 3
        depends_on:
            db:
                condition: service_healthy
            redis:
                condition: service_healthy
            keycloak:
                condition: service_healthy
            polis-server:
                condition: service_healthy
            nlp:
                condition: service_started
        volumes:
            - ./backend/server/controllers:/usr/src/app/candid/controllers # Live-reload controllers in dev

    db:
        build:
            context: .
            dockerfile: backend/database/Dockerfile
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data # Persist data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U user -d candid"]
            interval: 5s
            timeout: 5s
            retries: 5

    polis-server:
        build:
            context: ./backend/polis-integration/polis/server
            dockerfile: Dockerfile
            target: dev
        ports:
            - "5000:5000"
        environment:
            DATABASE_URL: postgres://user:postgres@db:5432/polis-dev
            DEV_MODE: "true"
            API_SERVER_PORT: 5000
            MATH_ENV: dev
            # Auth via Keycloak OIDC
            AUTH_ISSUER: http://keycloak:8180/realms/candid
            JWKS_URI: http://keycloak:8180/realms/candid/protocol/openid-connect/certs
            AUTH_AUDIENCE: users
            # Participant JWT keys (auto-generated if missing)
            POLIS_JWT_AUDIENCE: participants
            POLIS_JWT_ISSUER: https://pol.is/
        healthcheck:
            test: ["CMD-SHELL", "wget -qO- http://localhost:5000/api/v3/participationInit || exit 1"]
            interval: 10s
            timeout: 5s
            start_period: 30s
            retries: 3
        depends_on:
            db:
                condition: service_healthy
            keycloak:
                condition: service_healthy

    polis-math:
        build:
            context: ./backend/polis-integration/polis/math
            dockerfile: Dockerfile
        environment:
            DATABASE_URL: postgres://user:postgres@db:5432/polis-dev
            MATH_ENV: dev
        depends_on:
            db:
                condition: service_healthy

    keycloak:
        image: quay.io/keycloak/keycloak:26.0
        command: start-dev --import-realm
        ports:
            - "8180:8180"
        environment:
            KC_DB: postgres
            KC_DB_URL: jdbc:postgresql://db:5432/keycloak
            KC_DB_USERNAME: user
            KC_DB_PASSWORD: postgres
            KC_BOOTSTRAP_ADMIN_USERNAME: admin
            KC_BOOTSTRAP_ADMIN_PASSWORD: admin
            KC_HTTP_PORT: 8180
        volumes:
            - ./backend/keycloak/candid-realm.json:/opt/keycloak/data/import/candid-realm.json
            - ./backend/keycloak/themes/candid:/opt/keycloak/themes/candid
        depends_on:
            db:
                condition: service_healthy
        healthcheck:
            test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8180 && echo -e 'GET /realms/candid HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '\"realm\"'"]
            interval: 10s
            timeout: 5s
            start_period: 30s
            retries: 5

    redis:
        image: redis:7-alpine
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        command: redis-server --appendonly yes
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 3s
            retries: 3

    chat:
        build:
            context: .
            dockerfile: backend/chat-server/Dockerfile
        ports:
            - "8002:8002"
        environment:
            DATABASE_URL: postgresql://user:postgres@db:5432/candid
            REDIS_URL: redis://redis:6379
            KEYCLOAK_URL: http://keycloak:8180
            KEYCLOAK_REALM: candid
            PORT: 8002
        healthcheck:
            test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
            interval: 10s
            timeout: 5s
            start_period: 10s
            retries: 3
        depends_on:
            db:
                condition: service_healthy
            redis:
                condition: service_healthy
        volumes:
            - ./backend/chat-server:/app  # Mount for development

    nlp:
        build:
            context: ./backend/nlp-service
            dockerfile: Dockerfile
        ports:
            - "5001:5001"
        environment:
            DEVICE: cpu
            EMBEDDING_MODEL: all-MiniLM-L6-v2
            MAX_BATCH_SIZE: 32
        healthcheck:
            test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5001/health')"]
            interval: 30s
            timeout: 10s
            start_period: 60s
            retries: 3

volumes:
    postgres_data:
    redis_data:
