services:
    api:
        build:
            context: .
            dockerfile: backend/server/Dockerfile
        ports:
            - "8000:8000"
        environment:
            DATABASE_URL: postgresql://user:postgres@db:5432/candid
            FLASK_ENV: dev
            FLASK_APP: "app.app:create_app"
            # Polis integration
            POLIS_API_URL: http://polis:5000/api/v3
            POLIS_BASE_URL: http://polis:5000
            POLIS_ENABLED: "true"
            POLIS_TIMEOUT: "10"
            # Polis OIDC authentication (for admin operations)
            POLIS_OIDC_TOKEN_URL: https://polis:3000/oauth/token
            POLIS_OIDC_CLIENT_ID: dev-client-id
            POLIS_OIDC_CLIENT_SECRET: dev_auth-client_secret
            POLIS_ADMIN_EMAIL: admin@polis.test
            POLIS_ADMIN_PASSWORD: "Te$$tP@ssw0rd*"
            # Redis
            REDIS_URL: redis://redis:6379
            # Connection pooling
            DB_POOL_MIN: 4
            DB_POOL_MAX: 20
            # Worker processes (2x CPU cores is a good starting point)
            GUNICORN_WORKERS: 4
            # NLP service
            NLP_SERVICE_URL: http://nlp:5001
        healthcheck:
            test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/ui/')\" || exit 1"]
            interval: 10s
            timeout: 5s
            start_period: 15s
            retries: 3
        depends_on:
            db:
                condition: service_healthy
            redis:
                condition: service_healthy
            polis:
                condition: service_started
            nlp:
                condition: service_started
        volumes:
            - .:/app # Mount current directory to /app in container for development

    db:
        build:
            context: backend/database/
            dockerfile: ./Dockerfile
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data # Persist data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U user -d candid"]
            interval: 5s
            timeout: 5s
            retries: 5

    polis:
        build:
            context: ./backend/polis-sysbox
            dockerfile: Dockerfile
        runtime: sysbox-runc
        privileged: true
        ports:
          - "5000:5000"    # Polis API server
          - "5433:5432"    # Polis PostgreSQL (avoiding conflict with your db)
          - "8081:8080"    # Polis file server
          - "8005:8005"    # SES local email service
          - "3000:3000"    # OIDC simulator
          - "8001:8001"    # DynamoDB admin
          - "8080:80"      # Polis UI
          - "443:443"      # Polis UI
        volumes:
          - ./backend/polis-sysbox/polis:/workspace
          - polis_docker_data:/var/lib/docker
        working_dir: /workspace
        environment:
          - DOCKER_TLS_CERTDIR=

    redis:
        image: redis:7-alpine
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        command: redis-server --appendonly yes
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 3s
            retries: 3

    chat:
        build:
            context: .
            dockerfile: backend/chat-server/Dockerfile
        ports:
            - "8002:8002"
        environment:
            DATABASE_URL: postgresql://user:postgres@db:5432/candid
            REDIS_URL: redis://redis:6379
            JWT_SECRET: abc
            PORT: 8002
        healthcheck:
            test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
            interval: 10s
            timeout: 5s
            start_period: 10s
            retries: 3
        depends_on:
            db:
                condition: service_healthy
            redis:
                condition: service_healthy
        volumes:
            - ./backend/chat-server:/app  # Mount for development

    nlp:
        build:
            context: ./backend/nlp-service
            dockerfile: Dockerfile
        ports:
            - "5001:5001"
        environment:
            DEVICE: cpu
            EMBEDDING_MODEL: all-MiniLM-L6-v2
            MAX_BATCH_SIZE: 32
        healthcheck:
            test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5001/health')"]
            interval: 30s
            timeout: 10s
            start_period: 60s
            retries: 3

volumes:
    postgres_data:
    polis_docker_data:
    redis_data:
