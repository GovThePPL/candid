version: '3.8'

services:
    api:
        build:
            context: .
            dockerfile: backend/server/Dockerfile
        ports:
            - "8000:8000"
        environment:
            DATABASE_URL: postgresql://user:postgres@db:5432/candid
            FLASK_ENV: dev
            FLASK_APP: "app.app:create_app"
        depends_on:
            - db
        volumes:
            - .:/app # Mount current directory to /app in container for development
    db:
        build:
            context: backend/database/
            dockerfile: ./Dockerfile
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data # Persist data
    ui:
        image: nginx:alpine  # Use a lightweight Nginx image
        ports:
          - "8001:80"          # Map host port 80 to container port 80
        depends_on:
            - api
        volumes:
          - ./frontend/static:/usr/share/nginx/html:ro # Mount your static files
    
    polis:
        build:
            context: ./backend/polis-sysbox
            dockerfile: Dockerfile
        runtime: sysbox-runc
        privileged: true
        ports:
          - "5000:5000"    # Polis API server
          - "5433:5432"    # Polis PostgreSQL (avoiding conflict with your db)
          - "8080:8080"    # Polis file server
          - "8005:8005"    # SES local email service
          - "3000:3000"    # OIDC simulator
          - "8002:8001"    # DynamoDB admin (avoiding conflict with your UI)
        volumes:
          - ./backend/polis-sysbox/polis:/workspace
          - polis_docker_data:/var/lib/docker
        working_dir: /workspace
        environment:
          - DOCKER_TLS_CERTDIR=

volumes:
    postgres_data:
    polis_docker_data:
