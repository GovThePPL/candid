version: '3.8'

services:
    api:
        build:
            context: .
            dockerfile: backend/server/Dockerfile
        ports:
            - "8000:8000"
        environment:
            DATABASE_URL: postgresql://user:postgres@db:5432/candid
            FLASK_ENV: dev
            FLASK_APP: "app.app:create_app"
        depends_on:
            - db
        volumes:
            - .:/app # Mount current directory to /app in container for development
    db:
        build:
            context: backend/database/
            dockerfile: ./Dockerfile
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data # Persist data
    ui:
        image: nginx:alpine  # Use a lightweight Nginx image
        ports:
          - "8001:80"          # Map host port 80 to container port 80
        depends_on:
            - api
        volumes:
          - ./frontend/static:/usr/share/nginx/html:ro # Mount your static files
    
    polis:
        image: docker:dind
        runtime: sysbox-runc
        privileged: true
        ports:
          - "5000:5000"    # Polis API server
          - "8080:8080"    # Polis file server
          - "1080:1080"    # Maildev UI
          - "1025:1025"    # Maildev SMTP
          - "3000:3000"    # OIDC simulator
          - "5433:5432"    # Polis postgres (different port to avoid conflict)
        volumes:
          - ./backend/polis:/workspace
          - polis_docker_data:/var/lib/docker
        working_dir: /workspace
        environment:
          - DOCKER_TLS_CERTDIR=
        command: >
          sh -c "
            dockerd-entrypoint.sh &
            sleep 10 &&
            docker compose --profile postgres -f docker-compose.yml -f docker-compose.dev.yml up
          "

volumes:
    postgres_data:
    polis_docker_data:
